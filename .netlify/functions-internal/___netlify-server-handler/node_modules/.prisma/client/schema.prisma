// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Subscription
  subscription Subscription?

  // Instagram accounts
  instagramAccounts InstagramAccount[]

  // Campaigns
  campaigns Campaign[]

  // Message templates
  messageTemplates MessageTemplate[]

  // Analytics
  analytics Analytics[]

  // Lead lists
  leadLists LeadList[]
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  stripeCustomerId     String?
  stripeSubscriptionId String?
  plan                 String // starter, pro, enterprise
  status               String // active, canceled, past_due
  currentPeriodEnd     DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model InstagramAccount {
  id          String    @id @default(cuid())
  userId      String
  username    String
  password    String // encrypted
  accessToken String? // Instagram API access token
  proxy       String?
  connection  String? // Instagram API connection
  isActive    Boolean   @default(true)
  dailyLimit  Int       @default(50)
  lastLogin   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Campaigns using this account
  campaigns CampaignAccount[]

  // Sent messages
  sentMessages Message[]
}

model Campaign {
  id                String   @id @default(cuid())
  userId            String
  name              String
  description       String?
  status            String // draft, active, paused, completed
  messageTemplateId String?
  targetCriteria    Json? // filtering criteria
  schedule          Json? // scheduling settings
  settings          Json? // campaign settings
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Template
  messageTemplate MessageTemplate? @relation(fields: [messageTemplateId], references: [id])

  // Accounts used for this campaign
  accounts CampaignAccount[]

  // Messages sent
  messages Message[]

  // Analytics
  analytics Analytics[]
}

model CampaignAccount {
  id                 String   @id @default(cuid())
  campaignId         String
  instagramAccountId String
  createdAt          DateTime @default(now())

  campaign         Campaign         @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  instagramAccount InstagramAccount @relation(fields: [instagramAccountId], references: [id], onDelete: Cascade)

  @@unique([campaignId, instagramAccountId])
}

model MessageTemplate {
  id        String   @id @default(cuid())
  userId    String
  name      String
  content   String
  variables Json? // template variables
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Campaigns using this template
  campaigns Campaign[]
}

model Message {
  id                 String    @id @default(cuid())
  campaignId         String
  instagramAccountId String
  recipientUsername  String
  content            String
  status             String // pending, sent, failed, read
  sentAt             DateTime?
  error              String?
  createdAt          DateTime  @default(now())

  campaign         Campaign         @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  instagramAccount InstagramAccount @relation(fields: [instagramAccountId], references: [id], onDelete: Cascade)
}

model Analytics {
  id         String   @id @default(cuid())
  userId     String
  campaignId String?
  metric     String // messages_sent, success_rate, etc.
  value      Float
  metadata   Json?
  date       DateTime
  createdAt  DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model LeadList {
  id        String   @id @default(cuid())
  userId    String
  name      String
  usernames Json // array of usernames (as JSON for SQLite)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
