module.exports=[28371,e=>{"use strict";var t=e.i(47909),a=e.i(74017),s=e.i(96250),r=e.i(59756),n=e.i(61916),i=e.i(74677),o=e.i(69741),l=e.i(16795),d=e.i(87718),u=e.i(95169),c=e.i(47587),h=e.i(66012),p=e.i(70101),m=e.i(26937),g=e.i(10372),y=e.i(93695);e.i(52474);var f=e.i(220),w=e.i(89171),R=e.i(57597),v=e.i(69113),T=e.i(30580);class S{config;messageHistory=new Map;sessionStats=new Map;constructor(e={}){this.config={minDelay:3e4,maxDelay:18e4,typingDelay:2e3,readDelay:5e3,sessionRotation:!0,messageVariation:!0,warmupTime:3e5,activeHours:{start:9,end:21},...e}}getTypingDelay(){return this.config.typingDelay+1e3*Math.random()}getMessageDelay(){let{minDelay:e,maxDelay:t}=this.config;return Math.floor((Math.random()*(t-e)+e)*(.5+Math.abs((()=>{let e=0,t=0;for(;0===e;)e=Math.random(),t=Math.random();return e+1.3*t-.6})())))}varyMessage(e){if(!this.config.messageVariation)return e;let t=[e=>e.replace(/^(hi|hey|hello)/i,Math.random()>.5?"Hey":"Hi"),e=>e.replace(/[.!?]+/g,e=>{let t=[".","!","?","..."];return t[Math.floor(Math.random()*t.length)]}),e=>Math.random()>.7?e+(Math.random()>.5?" ðŸ‘‹":" ðŸ‘"):e.replace(/[ðŸ‘‹ðŸ‘]/g,""),e=>{let t=e.split(" ");return t.map((e,a)=>0===a&&Math.random()>.3?e.toLowerCase():a===t.length-1&&Math.random()>.3?e.toUpperCase():e).join(" ")}];return t[Math.floor(Math.random()*t.length)](e)}isActiveHours(){let e=new Date().getHours(),{start:t,end:a}=this.config.activeHours;return t<=a?e>=t&&e<a:e>=t||e<a}getBestSession(e){return this.sessionStats.get(e)&&Array.from(this.sessionStats.keys()).filter(t=>t.startsWith(e)).sort((e,t)=>{let a=this.sessionStats.get(e),s=this.sessionStats.get(t);return a.messageCount-s.messageCount})[0]||e}getOptimalSendTime(e,t){let a=new Date;this.sessionStats.get(e);let s=this.messageHistory.get(t)||[],r=new Date(s.length>0?Math.max(...s):0);if(a.getTime()-r.getTime()<3e5)return new Date(a.getTime()+3e5);let n=this.getMessageDelay(),i=a.getHours();return new Date(a.getTime()+n*(i>=19&&i<=21?1.5:1))}async simulateTyping(e){let t=this.getTypingDelay();return new Promise(e=>{setTimeout(e,t)})}async humanizeSend(e,t,a,s){if(!this.isActiveHours()){let t=this.config.activeHours.start,s=new Date;return s.setHours(t),s.setMinutes(0),s.setSeconds(0),{delay:s.getTime()-Date.now(),variedMessage:a,sendTime:s,sessionId:this.getBestSession(e)}}let r=this.getOptimalSendTime(e,t),n=r.getTime()-Date.now(),i=this.varyMessage(a),o=this.messageHistory.get(t)||[];o.push(Date.now()),this.messageHistory.set(t,o);let l=this.sessionStats.get(e)||{lastUsed:new Date,messageCount:0};return l.lastUsed=new Date,l.messageCount++,this.sessionStats.set(e,l),Math.random()>.7&&await this.simulateTyping(e),{delay:n,variedMessage:i,sendTime:r,sessionId:this.getBestSession(e)}}cleanupHistory(){let e=Date.now()-864e5;for(let[t,a]of this.messageHistory.entries()){let s=a.filter(t=>t>e);s.length>0?this.messageHistory.set(t,s):this.messageHistory.delete(t)}}getSessionStats(e){return this.sessionStats.get(e)||null}resetSessionStats(e){this.sessionStats.delete(e)}}let M=new S({minDelay:45e3,maxDelay:3e5,typingDelay:3e3,readDelay:15e3,sessionRotation:!0,messageVariation:!0,warmupTime:6e5,activeHours:{start:9,end:21}});async function E(e){try{let t=await (0,R.requireAuth)();if(t instanceof w.NextResponse)return t;let a=await (0,T.ensureDbUser)(t),{messageId:s,instagramAccountId:r}=await e.json().catch(()=>({}));if(!s||!r)return w.NextResponse.json({error:"messageId and instagramAccountId are required"},{status:400});let[n,i]=await Promise.all([v.prisma.message.findFirst({where:{id:s,campaign:{userId:a.id}},include:{campaign:!0}}),v.prisma.instagramAccount.findFirst({where:{id:r,userId:a.id}})]);if(!n||!i)return w.NextResponse.json({error:"Message or account not found"},{status:404});if(!i.accessToken)return w.NextResponse.json({error:"Instagram account not connected. Please connect your Instagram account first.",requiresAuth:!0},{status:400});try{let e=await M.humanizeSend(r,n.recipientUsername,n.content,n.threadId||void 0);e.delay>0&&await new Promise(t=>setTimeout(t,e.delay));let t=await fetch(`${process.env.NEXTAUTH_URL||"http://localhost:3000"}/api/instagram/send-single`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messageId:s,instagramAccountId:r})}),a=await t.json();if(a.success)return await v.prisma.message.update({where:{id:s},data:{content:e.variedMessage,status:"sent",sentAt:e.sendTime,threadId:a.threadId,error:null,metadata:{humanized:!0,originalDelay:e.delay,sessionId:e.sessionId,messageVariation:e.variedMessage!==n.content}}}),Math.random()>.6&&setTimeout(async()=>{try{console.log(`Marked as read: ${n.recipientUsername} in thread ${a.threadId}`)}catch(e){console.error("Failed to mark as read:",e)}},M.config.readDelay),w.NextResponse.json({success:!0,messageId:s,threadId:a.threadId,recipient:n.recipientUsername,sentAt:e.sendTime.toISOString(),humanized:{delay:e.delay,variedMessage:e.variedMessage,sessionId:e.sessionId,messageVariation:e.variedMessage!==n.content}});return await v.prisma.message.update({where:{id:s},data:{status:"failed",error:"Humanization delay failed",sentAt:new Date}}),w.NextResponse.json({success:!1,error:"Failed to apply humanization",messageId:s},{status:500})}catch(e){return console.error("Humanized send error:",e),await v.prisma.message.update({where:{id:s},data:{status:"failed",error:e instanceof Error?e.message:"Humanization error",sentAt:new Date}}),w.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Unknown error",messageId:s},{status:500})}}catch(e){return console.error("Humanized send API error:",e),w.NextResponse.json({error:e?.message||"Internal server error"},{status:500})}}e.s(["POST",()=>E],32468);var D=e.i(32468);let x=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/instagram/humanized-send/route",pathname:"/api/instagram/humanized-send",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/instadm-clone/src/app/api/instagram/humanized-send/route.ts",nextConfigOutput:"standalone",userland:D}),{workAsyncStorage:A,workUnitAsyncStorage:C,serverHooks:H}=x;function I(){return(0,s.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:C})}async function N(e,t,s){x.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/instagram/humanized-send/route";w=w.replace(/\/index$/,"")||"/";let R=await x.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:v,params:T,nextConfig:S,parsedUrl:M,isDraftMode:E,prerenderManifest:D,routerServerContext:A,isOnDemandRevalidate:C,revalidateOnlyGenerated:H,resolvedPathname:I,clientReferenceManifest:N,serverActionsManifest:P}=R,O=(0,o.normalizeAppPath)(w),U=!!(D.dynamicRoutes[O]||D.routes[I]),b=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,M,!1):t.end("This page could not be found"),null);if(U&&!E){let e=!!D.routes[I],t=D.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await b();throw new y.NoFallbackError}}let _=null;!U||x.isDev||E||(_="/index"===(_=I)?"/":_);let j=!0===x.isDev||!U,k=U&&!j;P&&N&&(0,i.setManifestsSingleton)({page:w,clientReferenceManifest:N,serverActionsManifest:P});let q=e.method||"GET",z=(0,n.getTracer)(),F=z.getActiveScopeSpan(),$={params:T,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,s,r)=>x.onRequestError(e,t,s,r,A)},sharedContext:{buildId:v}},B=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),V=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let i=async e=>x.handle(V,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=z.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${q} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${w}`)}),o=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var n,l;let d=async({previousCacheEntry:a})=>{try{if(!o&&C&&H&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(r);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&s.waitUntil&&(s.waitUntil(l),l=void 0);let d=$.renderOpts.collectedTags;if(!U)return await (0,h.sendResponse)(B,K,n,$.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,s=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==a?void 0:a.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:C})},!1,A),t}},u=await x.handleResponse({req:e,nextConfig:S,cacheKey:_,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:H,responseGenerator:d,waitUntil:s.waitUntil,isMinimalMode:o});if(!U)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,p.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&U||y.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(B,K,new Response(u.value.body,{headers:y,status:u.value.status||200})),null};F?await l(F):await z.withPropagatedContext(e.headers,()=>z.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${w}`,kind:n.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:C})},!1,A),U)throw t;return await (0,h.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>I,"routeModule",()=>x,"serverHooks",()=>H,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>C],28371)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_1877c8de.js.map