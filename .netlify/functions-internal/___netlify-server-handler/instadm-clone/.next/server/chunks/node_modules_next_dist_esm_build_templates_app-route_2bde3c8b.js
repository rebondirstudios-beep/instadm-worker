module.exports=[56131,e=>{"use strict";var t=e.i(47909),a=e.i(74017),r=e.i(96250),o=e.i(59756),i=e.i(61916),n=e.i(74677),s=e.i(69741),l=e.i(16795),u=e.i(87718),c=e.i(95169),d=e.i(47587),p=e.i(66012),m=e.i(70101),h=e.i(26937),g=e.i(10372),w=e.i(93695);e.i(52474);var f=e.i(220),b=e.i(89171),y=e.i(57597),x=e.i(69113),R=e.i(30580);async function v(e,t,a){let r;try{return await Promise.race([a(),new Promise((a,o)=>{r=setTimeout(()=>o(Error(`${e} timed out after ${t}ms`)),t)})])}finally{r&&clearTimeout(r)}}async function E(){if(console.error("[DEBUG] getPlaywright runtime:",globalThis.EdgeRuntime?"edge":"nodejs"),globalThis.EdgeRuntime)return{mod:null,error:"This route is running in Edge runtime. Set runtime='nodejs' and restart next dev."};try{return{mod:await e.A(84769),error:null}}catch(t){let e=t instanceof Error?t.message:"Failed to load Playwright";return console.error("[DEBUG] Playwright import error:",t),{mod:null,error:e}}}async function S(e,t){for(let a of t){let t=e.locator(a).first();if(await t.count())try{return await t.click({timeout:2e3}),!0}catch{}}return!1}async function P(e,t){let a=e.locator("textarea[placeholder='Message...'], textarea").first(),r=e.locator("div[role='textbox'][contenteditable='true'], div[contenteditable='true'][role='textbox']").first();try{return await a.waitFor({state:"visible",timeout:t}),{kind:"textarea",textarea:a,textbox:r}}catch{}return await r.waitFor({state:"visible",timeout:t}),{kind:"textbox",textarea:a,textbox:r}}async function T(e){try{let t=await e.storageState();return JSON.stringify(t)}catch{return null}}async function k(e){let t=await E(),a=t.mod;if(!a)return{ok:!1,storageStateJson:e.storageStateJson,error:t.error||"Playwright is not available. Ensure playwright is installed in this project and Next is using Node runtime.",debugTrace:["playwright_load_failed"],screenshotPath:null};let{chromium:r}=a,o=function(e){if(e)try{let t=JSON.parse(e),a=String(t?.type||"http"),r=String(t?.host||""),o=String(t?.port||"");if(!r||!o)return;let i=`${a}://${r}:${o}`,n=t?.username?String(t.username):void 0,s=t?.password?String(t.password):void 0;return{server:i,...n?{username:n}:{},...s?{password:s}:{}}}catch{return}}(e.proxy),i=await r.launch({headless:e.headless,...o?{proxy:o}:{}}),n=await i.newContext({...e.storageStateJson?(()=>{try{return{storageState:JSON.parse(e.storageStateJson)}}catch{return{}}})():{}}),s=await n.newPage();s.setDefaultTimeout(6e4),s.setDefaultNavigationTimeout(6e4);let l=[],u=null,c=e=>{let t=`[${new Date().toISOString()}] ${e}`;l.push(t),console.log(t)};try{return await v("playwright_send",e.headless?9e4:18e4,async()=>{c("goto /direct/inbox (login check)"),await s.goto("https://www.instagram.com/direct/inbox/",{waitUntil:"domcontentloaded"}),await S(s,["button:has-text('Only allow essential cookies')","button:has-text('Allow essential and optional cookies')","button:has-text('Allow all cookies')"]);let t=await s.locator("input[name='username'], input[autocomplete='username'], input[aria-label*='username'], input[aria-label*='email'], input[aria-label*='Phone number']").first().isVisible({timeout:2e3}).catch(()=>!1),a=s.url();if(c(`inbox url=${a}`),!(!t&&!a.includes("/accounts/login")&&!a.includes("checkpoint")&&!a.includes("challenge")&&!a.includes("two_factor"))){c("goto /accounts/login"),await s.goto("https://www.instagram.com/accounts/login/",{waitUntil:"domcontentloaded"});let t=s.locator("input[name='username'], input[autocomplete='username'], input[aria-label*='username'], input[aria-label*='email'], input[aria-label*='Phone number']").first(),a=s.locator("input[name='password'], input[autocomplete='current-password'], input[aria-label*='Password']").first();if(await t.isVisible({timeout:5e3}).catch(()=>!1))c("login form detected: autofill credentials"),await t.fill(e.loginUsername),await a.fill(e.loginPassword),await s.locator("button[type='submit']").click();else{if(e.headless)throw Error("Login form not detected (step=login_form). Try headless=false.");c("login form not detected: waiting for manual login")}if(await s.waitForTimeout(12e3),s.url().includes("challenge")||s.url().includes("two_factor")||s.url().includes("checkpoint")){if(c(`challenge detected url=${s.url()}`),e.headless)return{ok:!1,storageStateJson:e.storageStateJson,error:"Instagram requires verification (2FA/challenge). Run in headless=false and complete login, then retry.",debugTrace:l,screenshotPath:null};for(let e=0;e<12&&(await s.waitForTimeout(5e3),s.url().includes("challenge")||s.url().includes("two_factor")||s.url().includes("checkpoint"));e++);await s.waitForTimeout(5e3),c(`challenge wait done url=${s.url()}`)}if(await s.waitForSelector("a[href='/direct/inbox/']",{timeout:e.headless?3e4:18e4}),!(await s.locator("a[href='/direct/inbox/']").count()>0))return{ok:!1,storageStateJson:e.storageStateJson,error:"Login failed (could not detect inbox). Check username/password or complete verification.",debugTrace:l,screenshotPath:null};c("login ok (inbox detected)")}let r=String(e.recipientUsername||"").replace(/^@/,"").trim();if(!r)throw Error("Invalid recipient username");c(`goto profile @${r}`),await s.goto(`https://www.instagram.com/${r}/`,{waitUntil:"domcontentloaded"}),await s.waitForTimeout(2500);let o=s.url();if(o.includes("/accounts/login")||o.includes("checkpoint")||o.includes("challenge")||o.includes("two_factor"))throw Error("Instagram session not authenticated (step=profile_open)");if(await s.locator("text=Sorry, this page isn't available.").first().isVisible({timeout:1e3}).catch(()=>!1)||await s.locator("text=Profile isn't available").first().isVisible({timeout:1e3}).catch(()=>!1)||await s.locator("text=Profile isnâ€™t available").first().isVisible({timeout:1e3}).catch(()=>!1)||await s.locator("text=The link you followed may be broken").first().isVisible({timeout:1e3}).catch(()=>!1))throw Error(`Profile @${r} not available (step=profile_open)`);let i=await s.locator("text=This Account is Private").first().isVisible({timeout:1e3}).catch(()=>!1)||await s.locator("text=This account is private").first().isVisible({timeout:1e3}).catch(()=>!1)||await s.locator("text=Private Account").first().isVisible({timeout:1e3}).catch(()=>!1);await S(s,["button:has-text('Not Now')"]);let u=["button:has-text('Message')","div[role='button']:has-text('Message')","a:has-text('Message')","button:has-text('Send message')","div[role='button']:has-text('Send message')","button[aria-label*='Message']","div[aria-label*='Message']"],d=null;for(let e of u)try{let t=s.locator(e).first();if(await t.isVisible({timeout:2e3})){d=t;break}}catch{}if(!d){if(i)if(c("private account detected: attempting Follow/Request"),await S(s,["button:has-text('Follow')","div[role='button']:has-text('Follow')","button:has-text('Request')","div[role='button']:has-text('Request')"]))for(let e of(c("Follow/Request clicked; waiting for UI to update"),await s.waitForTimeout(3e3),u))try{let t=s.locator(e).first();if(await t.isVisible({timeout:2e3})){d=t,c("Message button appeared after Follow/Request");break}}catch{}else c("no Follow/Request button found");if(!d)throw Error(i?"Cannot message this user (private account / not approved) (step=message_button)":"Could not find Message button on profile (step=message_button)")}c("click Message"),await d.scrollIntoViewIfNeeded().catch(()=>{});let p=s.waitForURL(e=>String(e).includes("/direct/"),{timeout:15e3}).catch(()=>null);try{await Promise.all([p,d.click({timeout:8e3})])}catch{await Promise.all([p,d.click({timeout:8e3,force:!0})])}let m=await P(s,e.headless?15e3:3e4).catch(()=>null);if(!m)throw Error("Could not find message input (step=compose)");c(`composer ready kind=${m.kind}`),"textarea"===m.kind?(await m.textarea.click({timeout:8e3}),await m.textarea.fill(e.text)):(await m.textbox.click({timeout:8e3}),await s.keyboard.type(e.text,{delay:10})),await S(s,["div[role='button']:has-text('Send')","button:has-text('Send')"])||await s.keyboard.press("Enter"),c("send triggered"),await s.waitForTimeout(2e3);let h=await T(n);return{ok:!0,storageStateJson:h??e.storageStateJson,error:null,debugTrace:l,screenshotPath:null}})}catch(a){let t=await T(n);try{u=`playwright-failure-${Date.now()}.png`,await s.screenshot({path:u,fullPage:!0})}catch{}return{ok:!1,storageStateJson:t??e.storageStateJson,error:a instanceof Error?a.message:"Failed to send via Playwright",debugTrace:l,screenshotPath:u}}finally{await n.close().catch(()=>{}),await i.close().catch(()=>{})}}var A=e.i(89922);let M=process.env.WORKER_URL;async function N(e){try{let t=await (0,y.requireAuth)();if(t instanceof b.NextResponse)return t;let a=await (0,R.ensureDbUser)(t),r=await e.json().catch(()=>({})),o=r?.campaignId,i=r?.instagramAccountId,n=String(r?.senderMode||process.env.INSTAGRAM_SENDER_MODE||"simulated"),s=r?.headless!==!1&&"false"!==process.env.IG_PLAYWRIGHT_HEADLESS,l=r?.maxToProcess,u="number"==typeof l?Math.max(1,Math.min(50,Math.floor(l))):"string"==typeof l?Math.max(1,Math.min(50,Math.floor(Number(l)||50))):50,c=!!r?.skipDelay,d=r?.delayMinMs,p=r?.delayMaxMs,m="number"==typeof d?Math.max(0,Math.floor(d)):"string"==typeof d?Math.max(0,Math.floor(Number(d)||3e4)):3e4,h="number"==typeof p?Math.max(m,Math.floor(p)):"string"==typeof p?Math.max(m,Math.floor(Number(p)||6e4)):6e4;if(!o||!i)return b.NextResponse.json({error:"campaignId and instagramAccountId are required"},{status:400});let[g,w]=await Promise.all([x.prisma.campaign.findFirst({where:{id:o,userId:a.id}}),x.prisma.instagramAccount.findFirst({where:{id:i,userId:a.id}})]);if(!g||!w)return b.NextResponse.json({error:"Campaign or account not found"},{status:404});if("completed"===g.status)return b.NextResponse.json({error:"Campaign is completed"},{status:400});if(M)try{let e=await fetch(`${M}/send-messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({campaignId:o,instagramAccountId:i,senderMode:n,headless:s,maxToProcess:u,skipDelay:c,delayMinMs:m,delayMaxMs:h})});if(!e.ok){let t=await e.text();return b.NextResponse.json({error:`Worker error: ${t}`},{status:e.status})}let t=await e.json();return b.NextResponse.json(t)}catch(e){return console.error("Worker delegation failed:",e),b.NextResponse.json({error:`Failed to contact worker: ${e}`},{status:500})}if(!w.isActive)return b.NextResponse.json({error:"Instagram account is not active"},{status:400});let f=g.messageTemplateId?await x.prisma.messageTemplate.findFirst({where:{id:g.messageTemplateId,userId:a.id}}):null;f?.content;let v=await x.prisma.message.findMany({where:{campaignId:o,instagramAccountId:i,status:"pending"},orderBy:{createdAt:"asc"},take:u});if(0===v.length)return b.NextResponse.json({message:"No pending messages to send",processed:0},{status:200});let E=new Date;E.setHours(0,0,0,0);let[S,P]=await Promise.all([x.prisma.message.count({where:{instagramAccountId:i,status:"sent",sentAt:{gte:E}}}),x.prisma.message.count({where:{instagramAccountId:i,status:{in:["pending","sent"]},createdAt:{gte:E}}})]),T=w.dailyLimit||50,N=Math.max(T-S,0);if(N<=0)return b.NextResponse.json({error:`Daily limit reached (${S}/${T})`,sentToday:S,dailyLimit:T,processed:0},{status:429});let C={processed:0,sent:0,failed:0,skipped:0,errors:[],lastRecipientUsername:null,lastError:null,hardFailure:!1,attemptRecipientUsername:null,attemptOutcome:null,attemptError:null,attemptMs:null,attemptDebugTrace:null,attemptScreenshotPath:null};for(let e of v){let t=Date.now();if(C.attemptRecipientUsername=e.recipientUsername,C.attemptOutcome=null,C.attemptError=null,C.attemptMs=null,C.attemptDebugTrace=null,C.attemptScreenshotPath=null,C.sent>=N){C.skipped++,C.errors.push(`Daily limit reached. Stopped at ${C.sent}/${N} messages.`),C.attemptOutcome="skipped",C.attemptMs=Date.now()-t;break}try{if(!c){let e=Math.floor(Math.random()*(h-m+1))+m;await function(e){return new Promise(t=>setTimeout(t,e))}(e)}if("playwright"===n){if(!w.password)throw Error("Missing Instagram password for this account. Re-add the account with a password.");let t=(0,A.decryptSecretMaybe)(w.password,process.env.IG_CREDENTIALS_KEY),a=await k({loginUsername:w.username,loginPassword:t,recipientUsername:e.recipientUsername,text:e.content,proxy:w.proxy,storageStateJson:w.connection??null,headless:s});if(C.attemptDebugTrace=Array.isArray(a?.debugTrace)?a.debugTrace.slice(-30):null,C.attemptScreenshotPath="string"==typeof a?.screenshotPath?a.screenshotPath:null,a.storageStateJson&&a.storageStateJson!==(w.connection??null)&&await x.prisma.instagramAccount.update({where:{id:w.id},data:{connection:a.storageStateJson,lastLogin:new Date}}),!a.ok)throw Error(a.error||"Playwright send failed")}await x.prisma.message.update({where:{id:e.id},data:{status:"sent",sentAt:new Date,error:null}}),C.sent++,C.processed++,C.lastRecipientUsername=e.recipientUsername,C.attemptOutcome="sent",C.attemptMs=Date.now()-t,console.log(`Automated send: ${e.recipientUsername} via campaign ${g.name} (mode=${n})`)}catch(r){C.failed++,C.processed++;let a=r instanceof Error?r.message:String(r);if(C.lastError=a,C.attemptError=a,C.errors.push(`Failed to send to ${e.recipientUsername}: ${a}`),C.lastRecipientUsername=e.recipientUsername,C.attemptOutcome="failed",C.attemptMs=Date.now()-t,"playwright"===n&&function(e){let t=String(e||""),a=t.includes("Instagram requires verification")||t.includes("Login failed")||t.includes("step=login_form")||t.includes("Executable doesn't exist")||t.includes("Playwright is not available")||t.includes("Cannot find module 'playwright'")||t.includes("browserType.launch"),r=t.includes("step=profile_open")||t.includes("step=message_button")||t.includes("step=compose")||t.includes("not available")||t.includes("private account")||t.includes("not approved");return a&&!r}(a)&&(C.hardFailure=!0),console.log(`[DEBUG] Playwright error classification: hardFailure=${C.hardFailure} error="${a}"`),await x.prisma.message.update({where:{id:e.id},data:{status:"failed",error:a}}),C.hardFailure)break}}return b.NextResponse.json({success:!0,mode:"playwright"===n?"playwright":"simulated",...C,campaignId:o,instagramAccountId:i,dailyLimit:T,sentToday:S,remainingToday:Math.max(N-C.sent,0)})}catch(e){return console.error("Automation send error:",e),b.NextResponse.json({error:e?.message||"Internal server error",processed:0},{status:500})}}e.s(["POST",()=>N,"runtime",0,"nodejs"],71036);var C=e.i(71036);let _=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/automation/send-messages/route",pathname:"/api/automation/send-messages",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/instadm-clone/src/app/api/automation/send-messages/route.ts",nextConfigOutput:"standalone",userland:C}),{workAsyncStorage:U,workUnitAsyncStorage:I,serverHooks:D}=_;function $(){return(0,r.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:I})}async function F(e,t,r){_.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/automation/send-messages/route";b=b.replace(/\/index$/,"")||"/";let y=await _.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:x,params:R,nextConfig:v,parsedUrl:E,isDraftMode:S,prerenderManifest:P,routerServerContext:T,isOnDemandRevalidate:k,revalidateOnlyGenerated:A,resolvedPathname:M,clientReferenceManifest:N,serverActionsManifest:C}=y,U=(0,s.normalizeAppPath)(b),I=!!(P.dynamicRoutes[U]||P.routes[M]),D=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,E,!1):t.end("This page could not be found"),null);if(I&&!S){let e=!!P.routes[M],t=P.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await D();throw new w.NoFallbackError}}let $=null;!I||_.isDev||S||($="/index"===($=M)?"/":$);let F=!0===_.isDev||!I,O=I&&!F;C&&N&&(0,n.setManifestsSingleton)({page:b,clientReferenceManifest:N,serverActionsManifest:C});let j=e.method||"GET",q=(0,i.getTracer)(),H=q.getActiveScopeSpan(),J={params:R,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:F,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,o)=>_.onRequestError(e,t,r,o,T)},sharedContext:{buildId:x}},L=new l.NodeNextRequest(e),V=new l.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(L,(0,u.signalFromNodeResponse)(t));try{let n=async e=>_.handle(G,J).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=q.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${j} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${b}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var i,l;let u=async({previousCacheEntry:a})=>{try{if(!s&&k&&A&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(o);e.fetchMetrics=J.renderOpts.fetchMetrics;let l=J.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=J.renderOpts.collectedTags;if(!I)return await (0,p.sendResponse)(L,V,i,J.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[g.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==J.renderOpts.collectedRevalidate&&!(J.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&J.renderOpts.collectedRevalidate,r=void 0===J.renderOpts.collectedExpire||J.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:J.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:k})},!1,T),t}},c=await _.handleResponse({req:e,nextConfig:v,cacheKey:$,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:A,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:s});if(!I)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",k?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let w=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&I||w.delete(g.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||w.get("Cache-Control")||w.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(L,V,new Response(c.value.body,{headers:w,status:c.value.status||200})),null};H?await l(H):await q.withPropagatedContext(e.headers,()=>q.trace(c.BaseServerSpan.handleRequest,{spanName:`${j} ${b}`,kind:i.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:k})},!1,T),I)throw t;return await (0,p.sendResponse)(L,V,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>$,"routeModule",()=>_,"serverHooks",()=>D,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>I],56131)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_2bde3c8b.js.map